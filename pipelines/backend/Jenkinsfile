// ============================================================
// Emart Login Service - Backend Team Jenkins Pipeline
// CI/CD: Dev -> Staging -> Production
// Team: Backend Team (Java)
// ============================================================

pipeline {
    agent any

    environment {
        APP_NAME          = 'emart-login-backend'
        DOCKER_REGISTRY   = credentials('docker-registry-url')
        DOCKER_CREDS      = credentials('docker-registry-credentials')
        SONAR_TOKEN       = credentials('sonarqube-token')
        MONGO_URI_DEV     = credentials('mongo-uri-dev')
        MONGO_URI_STAGING = credentials('mongo-uri-staging')
        MONGO_URI_PROD    = credentials('mongo-uri-prod')
        JWT_SECRET        = credentials('jwt-secret')
        SLACK_WEBHOOK     = credentials('slack-webhook')
        KUBECONFIG_DEV    = credentials('kubeconfig-dev')
        KUBECONFIG_PROD   = credentials('kubeconfig-prod')
    }

    parameters {
        choice(name: 'DEPLOY_ENV',
               choices: ['dev', 'staging', 'prod'],
               description: 'Target deployment environment')
        booleanParam(name: 'RUN_INTEGRATION_TESTS',
                     defaultValue: true,
                     description: 'Run integration tests with Testcontainers')
        booleanParam(name: 'SKIP_SONAR',
                     defaultValue: false,
                     description: 'Skip SonarQube analysis')
        string(name: 'IMAGE_TAG',
               defaultValue: '',
               description: 'Docker image tag (leave empty for auto: branch-commit)')
    }

    options {
        timeout(time: 45, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        disableConcurrentBuilds()
    }

    stages {

        // ====================================================
        // STAGE 1: SOURCE CHECKOUT
        // ====================================================
        stage('Checkout') {
            steps {
                script {
                    echo "=== [BACKEND] Checking out source code ==="
                    checkout scm
                    env.GIT_COMMIT_SHORT = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                    env.BUILD_TAG = params.IMAGE_TAG ?:
                        "${env.BRANCH_NAME}-${env.GIT_COMMIT_SHORT}-${env.BUILD_NUMBER}"
                    echo "Build Tag: ${env.BUILD_TAG}"
                }
            }
        }

        // ====================================================
        // STAGE 2: UNIT TESTS
        // Runs on every commit - fast feedback
        // ====================================================
        stage('Unit Tests') {
            steps {
                dir('backend') {
                    sh '''
                        echo "=== [BACKEND] Running Unit Tests ==="
                        mvn clean test \
                            -Dspring.profiles.active=test \
                            -Dsurefire.failIfNoSpecifiedTests=false \
                            --batch-mode
                    '''
                }
            }
            post {
                always {
                    dir('backend') {
                        junit 'target/surefire-reports/**/*.xml'
                        jacoco(
                            execPattern: 'target/jacoco.exec',
                            classPattern: 'target/classes',
                            sourcePattern: 'src/main/java',
                            minimumLineCoverage: '80'
                        )
                    }
                }
                failure {
                    script { notifySlack("FAILED", "Unit Tests FAILED on ${env.BRANCH_NAME}") }
                }
            }
        }

        // ====================================================
        // STAGE 3: CODE QUALITY - SonarQube
        // ====================================================
        stage('Code Quality Scan') {
            when { expression { !params.SKIP_SONAR } }
            steps {
                dir('backend') {
                    withSonarQubeEnv('SonarQube') {
                        sh '''
                            echo "=== [BACKEND] SonarQube Analysis ==="
                            mvn sonar:sonar \
                                -Dsonar.projectKey=emart-login-backend \
                                -Dsonar.projectName="Emart Login Backend" \
                                -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
                                --batch-mode
                        '''
                    }
                    timeout(time: 5, unit: 'MINUTES') {
                        waitForQualityGate abortPipeline: true
                    }
                }
            }
        }

        // ====================================================
        // STAGE 4: INTEGRATION TESTS (Testcontainers)
        // Runs real MongoDB via Docker
        // ====================================================
        stage('Integration Tests') {
            when { expression { params.RUN_INTEGRATION_TESTS } }
            steps {
                dir('backend') {
                    sh '''
                        echo "=== [BACKEND] Running Integration Tests with Testcontainers ==="
                        mvn verify \
                            -P integration-test \
                            -Dspring.profiles.active=test \
                            --batch-mode
                    '''
                }
            }
            post {
                always {
                    dir('backend') {
                        junit 'target/surefire-reports/**/*.xml'
                        junit allowEmptyResults: true, testResults: 'target/failsafe-reports/**/*.xml'
                    }
                }
            }
        }

        // ====================================================
        // STAGE 5: BUILD & PACKAGE
        // ====================================================
        stage('Build Docker Image') {
            steps {
                dir('backend') {
                    script {
                        echo "=== [BACKEND] Building Docker image: ${env.BUILD_TAG} ==="
                        sh """
                            mvn package -DskipTests --batch-mode
                            docker build \
                                -t ${DOCKER_REGISTRY}/${APP_NAME}:${env.BUILD_TAG} \
                                -t ${DOCKER_REGISTRY}/${APP_NAME}:latest \
                                --label "git-commit=${env.GIT_COMMIT_SHORT}" \
                                --label "build-number=${env.BUILD_NUMBER}" \
                                .
                        """
                    }
                }
            }
        }

        // ====================================================
        // STAGE 6: SECURITY SCAN - Trivy
        // ====================================================
        stage('Container Security Scan') {
            steps {
                sh """
                    echo "=== [BACKEND] Trivy Security Scan ==="
                    trivy image \
                        --exit-code 1 \
                        --severity CRITICAL \
                        --no-progress \
                        ${DOCKER_REGISTRY}/${APP_NAME}:${env.BUILD_TAG} || true
                """
            }
        }

        // ====================================================
        // STAGE 7: PUSH TO REGISTRY
        // ====================================================
        stage('Push to Registry') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'docker-registry-credentials',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh """
                        echo "=== [BACKEND] Pushing image to registry ==="
                        docker login ${DOCKER_REGISTRY} -u ${DOCKER_USER} -p ${DOCKER_PASS}
                        docker push ${DOCKER_REGISTRY}/${APP_NAME}:${env.BUILD_TAG}
                        docker push ${DOCKER_REGISTRY}/${APP_NAME}:latest
                    """
                }
            }
        }

        // ====================================================
        // STAGE 8A: DEPLOY TO DEV
        // ====================================================
        stage('Deploy to DEV') {
            when { 
                anyOf {
                    branch 'develop'
                    expression { params.DEPLOY_ENV == 'dev' }
                }
            }
            environment {
                KUBECONFIG = "${KUBECONFIG_DEV}"
                NAMESPACE = 'emart-dev'
                SPRING_PROFILE = 'dev'
                LOG_LEVEL = 'DEBUG'
                REPLICAS = '1'
                MIN_REPLICAS = '1'
                MAX_REPLICAS = '3'
                MONGO_URI = "${MONGO_URI_DEV}"
            }
            steps {
                script {
                    deployToKubernetes('dev')
                }
            }
            post {
                success {
                    script {
                        // API Tests against DEV
                        sh """
                            echo "=== [BACKEND] Running API Tests against DEV ==="
                            sleep 30  # Wait for pod to be ready
                            mvn test -P api-test \
                                -DAPI_BASE_URL=http://dev.emart.internal:8080 \
                                --batch-mode \
                                -f backend/pom.xml
                        """
                        notifySlack("SUCCESS", "Backend deployed to DEV. API tests passed.")
                    }
                }
            }
        }

        // ====================================================
        // STAGE 8B: DEPLOY TO STAGING (requires main branch)
        // ====================================================
        stage('Deploy to Staging') {
            when {
                anyOf {
                    branch 'main'
                    expression { params.DEPLOY_ENV == 'staging' }
                }
            }
            environment {
                KUBECONFIG = "${KUBECONFIG_DEV}"
                NAMESPACE = 'emart-staging'
                SPRING_PROFILE = 'staging'
                LOG_LEVEL = 'INFO'
                REPLICAS = '2'
                MIN_REPLICAS = '2'
                MAX_REPLICAS = '5'
                MONGO_URI = "${MONGO_URI_STAGING}"
            }
            steps {
                script { deployToKubernetes('staging') }
            }
            post {
                success {
                    script {
                        sh """
                            echo "=== [BACKEND] Running API Tests against STAGING ==="
                            sleep 30
                            mvn test -P api-test \
                                -DAPI_BASE_URL=http://staging.emart.internal:8080 \
                                --batch-mode \
                                -f backend/pom.xml
                        """
                        notifySlack("SUCCESS", "Backend deployed to STAGING. Awaiting prod approval.")
                    }
                }
            }
        }

        // ====================================================
        // STAGE 8C: DEPLOY TO PRODUCTION (manual approval)
        // ====================================================
        stage('Production Approval') {
            when {
                anyOf {
                    branch 'main'
                    expression { params.DEPLOY_ENV == 'prod' }
                }
            }
            steps {
                script {
                    def approvers = emailext(
                        subject: "[EMART] Approve Backend Production Deployment - Build ${env.BUILD_TAG}",
                        body: """
                        Backend deployment ready for PRODUCTION.
                        Image: ${DOCKER_REGISTRY}/${APP_NAME}:${env.BUILD_TAG}
                        Git: ${env.GIT_COMMIT_SHORT}
                        Staging tests: PASSED
                        Please approve: ${env.BUILD_URL}
                        """,
                        to: 'backend-lead@emart.com,devops@emart.com'
                    )

                    timeout(time: 30, unit: 'MINUTES') {
                        input(
                            message: "Deploy Backend to PRODUCTION?",
                            ok: "Deploy to Prod",
                            submitter: "backend-lead,devops-team"
                        )
                    }
                }
            }
        }

        stage('Deploy to Production') {
            when {
                anyOf {
                    branch 'main'
                    expression { params.DEPLOY_ENV == 'prod' }
                }
            }
            environment {
                KUBECONFIG = "${KUBECONFIG_PROD}"
                NAMESPACE = 'emart-prod'
                SPRING_PROFILE = 'prod'
                LOG_LEVEL = 'WARN'
                REPLICAS = '3'
                MIN_REPLICAS = '3'
                MAX_REPLICAS = '10'
                MONGO_URI = "${MONGO_URI_PROD}"
            }
            steps {
                script {
                    // Blue-Green or Canary based on env
                    deployToKubernetes('prod')
                }
            }
            post {
                success {
                    script {
                        sh """
                            echo "=== [BACKEND] Smoke test on PRODUCTION ==="
                            sleep 60
                            curl -f http://api.emart.com/health/ready
                            curl -f http://api.emart.com/health/live
                        """
                        notifySlack("SUCCESS", "Backend PRODUCTION deployment successful!")
                    }
                }
                failure {
                    script {
                        echo "=== PRODUCTION FAILED: Auto-rolling back ==="
                        sh "kubectl rollout undo deployment/emart-login-backend -n emart-prod"
                        notifySlack("FAILED", "BACKEND PRODUCTION FAILED! Rolled back automatically!")
                    }
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}

// ============================================================
// Helper Functions
// ============================================================
def deployToKubernetes(String env) {
    sh """
        echo "=== Deploying to ${env} ==="

        # Substitute env vars in template
        envsubst < k8s/backend/backend-deployment.yaml | kubectl apply -f -

        # Wait for rollout to complete
        kubectl rollout status deployment/emart-login-backend \
            -n ${env == 'prod' ? 'emart-prod' : "emart-${env}"} \
            --timeout=5m

        echo "=== Deployment to ${env} successful ==="
        kubectl get pods -n ${env == 'prod' ? 'emart-prod' : "emart-${env}"} \
            -l app=emart-login-backend
    """
}

def notifySlack(String status, String message) {
    def color = status == "SUCCESS" ? "good" : "danger"
    sh """
        curl -X POST -H 'Content-type: application/json' \
            --data '{"attachments": [{"color": "${color}", "text": "[Backend] ${message} | Build: ${env.BUILD_NUMBER}"}]}' \
            ${SLACK_WEBHOOK}
    """
}
