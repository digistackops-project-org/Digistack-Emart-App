# ============================================================
# /etc/nginx/sites-available/emart
#
# Single server block for the full Emart stack:
#   /           →  React SPA static files
#   /api/       →  Login Service (Spring Boot :8080)
#   /cart-api/  →  Cart Service  (Go :8081)
#
# Setup:
#   sudo cp nginx/emart.conf /etc/nginx/sites-available/emart
#   sudo ln -sf /etc/nginx/sites-available/emart /etc/nginx/sites-enabled/emart
#   sudo rm -f /etc/nginx/sites-enabled/default
#   sudo nginx -t
#   sudo systemctl reload nginx
# ============================================================

upstream login_service {
    server 127.0.0.1:8080;
    keepalive 32;
}

upstream cart_service {
    server 127.0.0.1:8081;
    keepalive 32;
}

server {
    listen 80;
    server_name _;

    root  /var/www/emart/frontend;
    index index.html;

    # ── Security headers ──────────────────────────────────
    add_header X-Frame-Options        "SAMEORIGIN"   always;
    add_header X-XSS-Protection       "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff"       always;
    add_header Referrer-Policy        "strict-origin-when-cross-origin" always;

    # ── Gzip ─────────────────────────────────────────────
    gzip            on;
    gzip_comp_level 5;
    gzip_vary       on;
    gzip_types      text/plain text/css application/json
                    application/javascript text/javascript
                    image/svg+xml application/font-woff2;

    # ── Login Service  (/api/* → :8080) ──────────────────
    location /api/ {
        proxy_pass         http://login_service;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Connection        "";
        proxy_connect_timeout 10s;
        proxy_read_timeout    60s;
    }

    # ── Cart Service  (/cart-api/* → :8081) ──────────────
    # Rewrite strips /cart-api prefix so Go receives /api/v1/cart/...
    location /cart-api/ {
        rewrite            ^/cart-api/(.*)$ /$1 break;
        proxy_pass         http://cart_service;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Connection        "";
        proxy_connect_timeout 10s;
        proxy_read_timeout    30s;
    }

    # ── Internal health check (no upstream) ──────────────
    location = /nginx-health {
        access_log off;
        return 200 '{"status":"UP","service":"nginx"}';
        add_header Content-Type application/json;
    }

    # ── Static asset caching (JS, CSS, images) ───────────
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires           1y;
        add_header        Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # ── React SPA: fallback all unknown routes to index.html
    location / {
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }
}
