# Emart Cart Service + Redis - Kubernetes Manifests
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: emart-redis
  namespace: ${NAMESPACE}
  labels: { app: emart-redis, team: db }
spec:
  replicas: 1
  selector:
    matchLabels: { app: emart-redis }
  template:
    metadata:
      labels: { app: emart-redis }
    spec:
      containers:
        - name: redis
          image: redis:7.2-alpine
          args: ["--requirepass", "$(REDIS_PASSWORD)", "--save", "60", "1"]
          ports: [{ containerPort: 6379 }]
          env:
            - name: REDIS_PASSWORD
              valueFrom: { secretKeyRef: { name: cart-secrets, key: REDIS_PASSWORD } }
          resources:
            requests: { memory: "64Mi", cpu: "50m" }
            limits:   { memory: "256Mi", cpu: "200m" }
          livenessProbe:
            exec: { command: ["redis-cli", "ping"] }
            initialDelaySeconds: 15
            periodSeconds: 20
---
apiVersion: v1
kind: Service
metadata: { name: emart-redis-svc, namespace: "${NAMESPACE}" }
spec:
  selector: { app: emart-redis }
  ports: [{ port: 6379, targetPort: 6379 }]
  type: ClusterIP
---
apiVersion: v1
kind: Secret
metadata: { name: cart-secrets, namespace: "${NAMESPACE}" }
type: Opaque
stringData:
  MONGO_URI: "${CART_MONGO_URI}"
  JWT_SECRET: "${JWT_SECRET}"
  REDIS_PASSWORD: "${REDIS_PASSWORD}"
---
apiVersion: v1
kind: ConfigMap
metadata: { name: cart-config, namespace: "${NAMESPACE}" }
data:
  APP_ENV: "${APP_ENV}"
  APP_NAME: "emart-cart-service"
  SERVER_PORT: "8081"
  GIN_MODE: "${GIN_MODE}"
  MONGO_DATABASE: "cart"
  REDIS_ADDR: "emart-redis-svc:6379"
  REDIS_CART_TTL: "168h"
  SYNC_INTERVAL: "30s"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: emart-cart-service
  namespace: ${NAMESPACE}
  labels: { app: emart-cart-service, version: v1, team: backend }
spec:
  replicas: ${REPLICAS}
  selector:
    matchLabels: { app: emart-cart-service }
  strategy:
    type: RollingUpdate
    rollingUpdate: { maxSurge: 1, maxUnavailable: 0 }
  template:
    metadata:
      labels: { app: emart-cart-service, version: v1 }
    spec:
      securityContext: { runAsNonRoot: true, runAsUser: 1000 }
      terminationGracePeriodSeconds: 30
      containers:
        - name: cart-service
          image: ${DOCKER_REGISTRY}/emart-cart-service:${IMAGE_TAG}
          imagePullPolicy: Always
          ports: [{ containerPort: 8081, name: http }]
          envFrom:
            - configMapRef: { name: cart-config }
            - secretRef:    { name: cart-secrets }
          resources:
            requests: { memory: "64Mi", cpu: "50m" }
            limits:   { memory: "256Mi", cpu: "500m" }
          livenessProbe:
            httpGet: { path: /health/live, port: 8081 }
            initialDelaySeconds: 20
            periodSeconds: 30
            failureThreshold: 3
          readinessProbe:
            httpGet: { path: /health/ready, port: 8081 }
            initialDelaySeconds: 10
            periodSeconds: 10
            failureThreshold: 3
          startupProbe:
            httpGet: { path: /health/live, port: 8081 }
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 12
      imagePullSecrets: [{ name: registry-credentials }]
---
apiVersion: v1
kind: Service
metadata: { name: emart-cart-svc, namespace: "${NAMESPACE}" }
spec:
  selector: { app: emart-cart-service }
  ports: [{ port: 80, targetPort: 8081 }]
  type: ClusterIP
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata: { name: emart-cart-hpa, namespace: "${NAMESPACE}" }
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: emart-cart-service
  minReplicas: ${MIN_REPLICAS}
  maxReplicas: ${MAX_REPLICAS}
  metrics:
    - type: Resource
      resource:
        name: cpu
        target: { type: Utilization, averageUtilization: 70 }
